<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="style.css">
    
</head>
<body>
    <div class="container">
        
        <h1 class="py-3 ">LED Control via WebSocket <i class="fa-solid fa-wifi"></i></h1>
        <p id="status">Status: Not connected</p>
        <div class="mb-2">Device: <strong id="deviceName">Resolving IP...</strong>
            <button id="refreshIp" class="btn btn-sm btn-outline-secondary ms-2">Refresh IP</button>
        </div>
        <div class="btn-container">
       <button class="btn btn-success me-5" onclick="send('ON')">ON</button>
       <button class="btn btn-danger me-5" onclick="send('OFF')">OFF</button>
       <button class="btn btn-warning" onclick="send('TOGGLE')">TOGGLE</button>
       </div>
       <br>
       <label class="mt-3 fs-3 form-label" for="range4" >RANGE</label>
        <input class="col-12 col-md-6 d-block mx-auto my-3" type="range" class="form-range" min="0" max="255" value="0" id="range">
        <div class="fs-2 text-success "><span >Value:</span> <output for="range4" id="rangeValue" aria-hidden="true"></output></div>
        <i class="fire fa-solid fa-lightbulb"></i>
    
        <div class="log-items">
        </div>
    </div>

    <script>
       let HOST=location.origin.replace(/^http/,"ws");
       let ws=new WebSocket(HOST);

        // derive device name from WebSocket server
        let deviceName = 'Unknown Device';
        const deviceNameEl = document.getElementById('deviceName');
        const refreshBtn = document.getElementById('refreshIp');

        function setDeviceName(name) {
            // Remove IPv6 prefix if present (::ffff:)
            if (name && name.includes('::ffff:')) {
                name = name.replace('::ffff:', '');
            }
            deviceName = name || 'Unknown Device';
            deviceNameEl.textContent = deviceName;
        }

        // Get DOM elements early (before WebSocket handlers)
        const rangeInput = document.getElementById('range');
        const rangeOutput = document.getElementById('rangeValue');
        const lamp = document.querySelector('.fire');

        // Reusable WebSocket event handlers
        function handleOpen() {
            document.getElementById("status").innerText = "Welcome ,You Are Connected ✅";
        }

        function handleMessage(e) {
            try {
                const data = JSON.parse(e.data);
                if (data.type === 'client-info' && data.ip) {
                    setDeviceName(data.ip);
                } else if (data.type === 'log') {
                    // Received a log from another client
                    addLogToUI(data.timestamp, data.device, data.action);
                } else if (data.type === 'range-update') {
                    // Update range slider from another client
                    rangeInput.value = data.value;
                    rangeOutput.textContent = data.value;
                    rangeInput.style.filter=`drop-shadow(0 0 ${data.value / 40}px green)`;
                    lamp.style.color = `rgb(${0},${data.value},${0})`;
                    lamp.style.filter=`drop-shadow(0 0 ${data.value / 20}px white)`;
                } else if (data.type === 'state-change') {
                    // Update UI based on state change from another client
                    if (data.state === 'OFF') {
                        rangeInput.value = 0;
                        rangeOutput.textContent = 0;
                        rangeInput.disabled = true;
                        rangeInput.style.filter = 'none';
                        lamp.style.color = `rgb(0,0,0)`;
                        lamp.style.filter = 'none';
                    } else {
                        rangeInput.disabled = false;
                    }
                }
            } catch (err) {
                // Not JSON, ignore (it's a regular message like ON/OFF/TOGGLE)
            }
        }

        function handleClose() {
            document.getElementById("status").innerText = "Disconnected ❌";
        }

        // Setup WebSocket handlers
        function setupWebSocket(socket) {
            socket.onopen = handleOpen;
            socket.onmessage = handleMessage;
            socket.onclose = handleClose;
        }

        // Initialize WebSocket with handlers
        setupWebSocket(ws);

        // Refresh button handler
        refreshBtn.addEventListener('click', () => {
            deviceNameEl.textContent = 'Reconnecting...';
            ws.close();
            ws = new WebSocket(HOST);
            setupWebSocket(ws);
        });

        function send(msg) {
            if (ws.readyState === WebSocket.OPEN) ws.send(msg);
        }

        // Set initial value
        rangeOutput.textContent = rangeInput.value;

        rangeInput.addEventListener('input', function() {
            ws.send(this.value);
            this.style.filter=`drop-shadow(0 0 ${this.value / 40}px green)`
            rangeOutput.textContent = this.value;
            lamp.style.color = `rgb(${0},${this.value},${0})`;
            lamp.style.filter=`drop-shadow(0 0 ${this.value / 20}px white)`;
            
            // Broadcast range update to other clients
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'range-update',
                    value: this.value
                }));
            }
        });
        
        // Function to add log to UI
        function addLogToUI(timestamp, device, action) {
            logsContainer.style.display="block"
            let logMessage=document.createElement("div");
            logMessage.className="message"
            logMessage.innerHTML=`@\n                                    <span class="date">${timestamp}</span> :\n                                    <strong>${escapeHtml(device)}</strong> changed LED to ${action}`
            logsContainer.prepend(logMessage);
        }

        // Function to broadcast log to all clients (doesn't add to local UI)
        function broadcastLog(action) {
            const logData = {
                type: 'log',
                timestamp: new Date().toLocaleTimeString(),
                device: deviceName,
                action: action
            };
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(logData));
            }
        }

        let allBtns=document.querySelectorAll(".btn");
        let logsContainer=document.querySelector(".log-items")
        allBtns.forEach(btn=>{
            btn.addEventListener("click",(e)=>{
                const action = e.target.innerHTML;
                const timestamp = new Date().toLocaleTimeString();
                
                // Handle OFF state
                if (action === 'OFF') {
                    rangeInput.value = 0;
                    rangeOutput.textContent = 0;
                    rangeInput.disabled = true;
                    rangeInput.style.filter = 'none';
                    lamp.style.color = `rgb(0,0,0)`;
                    lamp.style.filter = 'none';
                    
                    // Broadcast state change
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'state-change',
                            state: 'OFF'
                        }));
                    }
                } else {
                    rangeInput.disabled = false;
                    
                    // Broadcast state change for ON/TOGGLE
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'state-change',
                            state: action
                        }));
                    }
                }
                
                // Add to local UI only
                addLogToUI(timestamp, deviceName, action);
                
                // Broadcast to other clients (they will add it to their UI)
                broadcastLog(action);
            })
        })
        rangeInput.addEventListener('change', function(e) {
            const action = e.target.value;
            const timestamp = new Date().toLocaleTimeString();
            
            // Add to local UI only
            addLogToUI(timestamp, deviceName, action);
            
            // Broadcast to other clients (they will add it to their UI)
            broadcastLog(action);
        })

        // avoid inserting raw HTML from device name
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/\"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</body>
</html>